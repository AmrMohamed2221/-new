<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0c0f;--surface:#111418;--surface2:#181c22;--border:#1e2530;--accent:#e8b13a;--accent2:#3ab8e8;--red:#e84a3a;--green:#3ae89a;--orange:#e8743a;--text:#c8d0dc;--text-dim:#5a6478;--text-bright:#eef2f8;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Cairo',sans-serif;min-height:100vh;overflow-x:hidden;direction:rtl;}
  body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}

  /* LOGIN */
  #loginScreen{position:fixed;inset:0;background:var(--bg);z-index:5000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;}
  .login-box{background:var(--surface);border:1px solid var(--border);width:440px;max-width:95vw;padding:48px 40px;position:relative;overflow:hidden;}
  .login-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));}
  .login-logo{font-size:32px;font-weight:900;color:var(--accent);margin-bottom:4px;}
  .login-sub{font-size:11px;color:var(--text-dim);margin-bottom:32px;}
  .login-label{display:block;font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:6px;letter-spacing:1px;}
  .login-input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:14px;padding:12px 14px;outline:none;margin-bottom:16px;transition:border-color .2s;direction:rtl;}
  .login-input:focus{border-color:var(--accent);}
  .login-btn{width:100%;background:var(--accent);color:#000;border:none;font-family:'Cairo',sans-serif;font-size:16px;font-weight:900;padding:14px;cursor:pointer;transition:all .2s;margin-top:8px;}
  .login-btn:hover{background:#f5c85c;transform:translateY(-1px);}
  .login-error{background:rgba(232,74,58,.1);border:1px solid rgba(232,74,58,.4);color:var(--red);font-size:13px;font-weight:600;padding:10px 14px;margin-bottom:14px;display:none;}
  .login-error.show{display:block;}
  .login-creds-hint{background:var(--surface2);border:1px solid var(--border);padding:16px 20px;width:440px;max-width:95vw;font-size:11px;color:var(--text-dim);}
  .login-creds-hint strong{color:var(--accent);display:block;margin-bottom:8px;font-size:12px;}
  .creds-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 20px;}
  .creds-row{display:flex;justify-content:space-between;gap:8px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04);}
  .creds-row:last-child{border:none;}
  .creds-user{color:var(--text);font-family:'JetBrains Mono',monospace;font-size:10px;}
  .creds-pass{color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:10px;}
  .loading-overlay{position:fixed;inset:0;background:rgba(10,12,15,.85);z-index:9000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
  .loading-overlay.show{display:flex;}
  .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-text{font-size:13px;color:var(--text-dim);font-weight:600;}

  /* HEADER */
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:10px;}
  .logo{font-size:24px;font-weight:900;color:var(--accent);}
  .logo span{color:var(--text-dim);font-size:10px;display:block;margin-top:-2px;font-weight:400;}
  .header-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .user-chip{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);padding:6px 12px;font-size:12px;font-weight:700;}
  .role-badge{font-size:9px;padding:2px 8px;font-weight:700;}
  .role-badge.admin{background:rgba(232,177,58,.2);color:var(--accent);border:1px solid rgba(232,177,58,.3);}
  .role-badge.user{background:rgba(58,184,232,.2);color:var(--accent2);border:1px solid rgba(58,184,232,.3);}
  select.ctrl{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:12px;padding:7px 12px;cursor:pointer;outline:none;transition:border-color .2s;}
  select.ctrl:focus{border-color:var(--accent);}
  .sync-badge{font-size:10px;font-weight:600;padding:4px 10px;border:1px solid;font-family:'JetBrains Mono',monospace;}
  .sync-badge.synced{color:var(--green);border-color:rgba(58,232,154,.3);background:rgba(58,232,154,.07);}
  .sync-badge.saving{color:var(--accent);border-color:rgba(232,177,58,.3);background:rgba(232,177,58,.07);animation:blink .6s infinite;}
  @keyframes blink{50%{opacity:.4}}
  .sync-badge.error{color:var(--red);border-color:rgba(232,74,58,.3);}

  /* BUTTONS */
  .btn{background:var(--accent);color:#000;border:none;font-family:'Cairo',sans-serif;font-size:14px;font-weight:700;padding:8px 18px;cursor:pointer;transition:all .2s;display:inline-block;}
  .btn:hover{background:#f5c85c;transform:translateY(-1px);}
  .btn.secondary{background:transparent;border:1px solid var(--accent);color:var(--accent);}
  .btn.secondary:hover{background:var(--accent);color:#000;}
  .btn.danger{background:var(--red);color:#fff;}
  .btn.danger:hover{background:#ff5f4f;}
  .btn.sm{font-size:12px;padding:5px 10px;}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text-dim);font-size:13px;}
  .btn.ghost:hover{border-color:var(--accent);color:var(--accent);transform:none;}
  .btn.logout{background:transparent;border:1px solid var(--border);color:var(--text-dim);font-size:12px;padding:6px 12px;}
  .btn.logout:hover{border-color:var(--red);color:var(--red);transform:none;}

  /* LAYOUT */
  .main{display:grid;grid-template-columns:1fr 260px;min-height:calc(100vh - 57px);}
  aside{background:var(--surface);border-left:1px solid var(--border);padding:20px 0;position:sticky;top:57px;height:calc(100vh - 57px);overflow-y:auto;order:2;}
  .nav-label{font-size:9px;font-weight:700;color:var(--text-dim);padding:0 20px 8px;letter-spacing:2px;text-transform:uppercase;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:11px 20px;cursor:pointer;transition:all .15s;border-right:3px solid transparent;font-size:14px;font-weight:600;color:var(--text-dim);}
  .nav-item:hover{background:var(--surface2);color:var(--text);border-right-color:var(--border);}
  .nav-item.active{background:var(--surface2);color:var(--accent);border-right-color:var(--accent);}
  .nav-item .icon{font-size:16px;width:22px;text-align:center;}
  .sidebar-divider{height:1px;background:var(--border);margin:12px 20px;}
  .sidebar-stat{padding:6px 20px;font-size:11px;display:flex;justify-content:space-between;color:var(--text-dim);}
  .sidebar-stat .val{font-weight:700;}
  .building-badge{background:rgba(232,177,58,.1);border:1px solid rgba(232,177,58,.25);color:var(--accent);font-size:11px;font-weight:700;padding:8px 20px;margin:6px 14px;text-align:center;}

  .content{padding:28px;overflow-y:auto;order:1;}
  .page{display:none;}
  .page.active{display:block;animation:fadeIn .25s ease;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .page-title{font-size:36px;font-weight:900;color:var(--text-bright);line-height:1.1;margin-bottom:4px;}
  .page-subtitle{font-size:11px;color:var(--text-dim);margin-bottom:24px;}

  /* VEHICLES */
  .vehicles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;}
  .vehicle-card{background:var(--surface);border:1px solid var(--border);padding:18px;position:relative;overflow:hidden;transition:border-color .2s,transform .2s;}
  .vehicle-card:hover{border-color:var(--accent);transform:translateY(-2px);}
  .vc-stripe{position:absolute;top:0;left:0;right:0;height:3px;}
  .vc-num{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:600;color:var(--text-bright);letter-spacing:2px;}
  .vc-type{font-size:11px;color:var(--text-dim);margin-bottom:10px;}
  .vc-row{display:flex;justify-content:space-between;font-size:12px;color:var(--text-dim);margin-bottom:3px;gap:8px;}
  .vc-row span{color:var(--text);font-size:11px;}
  .status-badge{display:inline-block;font-size:10px;font-weight:600;padding:3px 10px;margin-top:10px;border:1px solid;}
  .vc-actions{display:flex;gap:6px;margin-top:12px;}

  /* FILTER */
  .filter-bar{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;align-items:center;}
  .filter-bar input{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:12px;padding:8px 12px;outline:none;transition:border-color .2s;}
  .filter-bar input:focus{border-color:var(--accent);}
  .tag-row{display:flex;gap:5px;flex-wrap:wrap;}
  .tag{padding:4px 11px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);transition:all .15s;color:var(--text-dim);background:transparent;}
  .tag.active,.tag:hover{border-color:var(--accent);color:var(--accent);background:rgba(232,177,58,.05);}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--surface);border:1px solid var(--border);width:540px;max-width:95vw;max-height:90vh;overflow-y:auto;direction:rtl;}
  .modal-header{display:flex;justify-content:space-between;align-items:center;padding:18px 22px;border-bottom:1px solid var(--border);}
  .modal-title{font-size:20px;font-weight:900;color:var(--text-bright);}
  .modal-close{background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;}
  .modal-close:hover{color:var(--red);}
  .modal-body{padding:22px;}
  .modal-footer{display:flex;gap:10px;justify-content:flex-start;padding:14px 22px;border-top:1px solid var(--border);}
  .form-group{margin-bottom:16px;}
  .form-label{display:block;font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:5px;}
  .form-input,.form-select,.form-textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:13px;padding:9px 12px;outline:none;transition:border-color .2s;direction:rtl;}
  .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent);}
  .form-textarea{resize:vertical;min-height:75px;}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}

  /* REPORTS */
  .reports-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px;margin-bottom:28px;}
  .report-card{background:var(--surface);border:1px solid var(--border);padding:22px 18px;position:relative;overflow:hidden;}
  .report-card::after{content:'';position:absolute;bottom:0;right:0;width:60px;height:60px;background:radial-gradient(circle,rgba(232,177,58,.08) 0%,transparent 70%);}
  .report-icon{font-size:26px;margin-bottom:10px;}
  .report-value{font-size:42px;font-weight:900;color:var(--accent);line-height:1;margin-bottom:4px;}
  .report-label{font-size:11px;font-weight:600;color:var(--text-dim);}
  .chart-section{background:var(--surface);border:1px solid var(--border);padding:22px;margin-bottom:18px;}
  .chart-title{font-size:18px;font-weight:700;color:var(--text-bright);margin-bottom:18px;}
  .bar-chart{display:flex;align-items:flex-end;gap:5px;height:130px;overflow-x:auto;padding-bottom:4px;}
  .bar-group{display:flex;flex-direction:column;align-items:center;gap:5px;flex:1;min-width:34px;}
  .bar{width:100%;background:linear-gradient(180deg,var(--accent),rgba(232,177,58,.3));border-top:2px solid var(--accent);min-height:4px;}
  .bar:hover{opacity:.7;}
  .bar-label{font-size:9px;color:var(--text-dim);text-align:center;font-weight:600;}
  .bar-val{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);}
  .status-breakdown{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-bottom:22px;}
  .sb-card{background:var(--surface);border:1px solid var(--border);padding:14px;text-align:center;}
  .sb-val{font-size:34px;font-weight:900;}
  .sb-lab{font-size:10px;font-weight:600;color:var(--text-dim);}

  /* SETTINGS */
  .settings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:20px;}
  .settings-card{background:var(--surface);border:1px solid var(--border);padding:22px;}
  .settings-card-title{font-size:19px;font-weight:700;color:var(--text-bright);margin-bottom:4px;}
  .settings-card-sub{font-size:10px;color:var(--text-dim);margin-bottom:16px;}
  .item-list{list-style:none;margin-bottom:14px;}
  .item-list li{padding:7px 0;border-bottom:1px solid var(--border);}
  .item-list li:last-child{border-bottom:none;}
  .item-row{display:flex;align-items:center;gap:7px;}
  .item-color-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
  .item-name{flex:1;font-size:13px;color:var(--text);}
  .item-edit-row{display:none;margin-top:7px;gap:5px;align-items:center;}
  .item-edit-row.active{display:flex;}
  .item-edit-row input{flex:1;background:var(--bg);border:1px solid var(--accent);color:var(--text);font-family:'Cairo',sans-serif;font-size:13px;padding:5px 9px;outline:none;}
  .add-item-row{display:flex;gap:7px;margin-top:4px;}
  .add-item-row input{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Cairo',sans-serif;font-size:13px;padding:7px 11px;outline:none;transition:border-color .2s;}
  .add-item-row input:focus{border-color:var(--accent);}
  .color-swatches{display:flex;gap:5px;flex-wrap:wrap;margin-top:7px;}
  .swatch{width:21px;height:21px;cursor:pointer;border:2px solid transparent;transition:border-color .15s;}
  .swatch.selected{border-color:#fff;outline:1px solid #666;}

  /* USERS TABLE */
  .user-table{width:100%;border-collapse:collapse;}
  .user-table th{font-size:10px;font-weight:700;color:var(--text-dim);text-align:right;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--surface2);letter-spacing:1px;}
  .user-table td{padding:10px 12px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle;}
  .user-table tr:hover td{background:var(--surface2);}

  /* DATA INFO */
  .data-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;}
  .data-info{font-size:12px;color:var(--text-dim);margin-bottom:12px;line-height:2;}
  .data-info span{color:var(--accent);font-weight:700;}
  .danger-zone{margin-top:18px;padding-top:14px;border-top:1px solid rgba(232,74,58,.2);}
  .danger-zone-label{font-size:10px;color:var(--red);margin-bottom:8px;font-weight:700;letter-spacing:1px;}

  /* TOAST */
  .toast{position:fixed;bottom:22px;left:22px;background:var(--surface);border:1px solid var(--green);color:var(--green);font-family:'Cairo',sans-serif;font-size:12px;font-weight:600;padding:11px 18px;z-index:8000;transform:translateY(80px);opacity:0;transition:all .3s;max-width:300px;}
  .toast.show{transform:translateY(0);opacity:1;}
  .empty{text-align:center;padding:55px 20px;color:var(--text-dim);font-size:13px;}
  .empty-icon{font-size:44px;margin-bottom:14px;opacity:0.3;}
  ::-webkit-scrollbar{width:5px;height:5px;}
  ::-webkit-scrollbar-track{background:var(--bg);}
  ::-webkit-scrollbar-thumb{background:var(--border);}
  @media(max-width:768px){.main{grid-template-columns:1fr;}aside{display:none;}.form-row{grid-template-columns:1fr;}header{padding:10px 14px;}.content{padding:14px;}}
</style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Ø¬Ø§Ø±Ù Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
</div>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬</div>
    <div class="login-sub">// Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª â€” ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div class="login-error" id="loginError">âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
    <label class="login-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
    <input class="login-input" id="loginUser" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" onkeydown="if(event.key==='Enter')document.getElementById('loginPass').focus()" autocomplete="username"/>
    <label class="login-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input class="login-input" id="loginPass" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" onkeydown="if(event.key==='Enter')doLogin()" autocomplete="current-password"/>
    <button class="login-btn" onclick="doLogin()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>

</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<header>
  <div class="logo">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ <span>// Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</span></div>
  <div class="header-controls">
    <div class="sync-badge" id="syncBadge">âŸ³ Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
    <div class="user-chip"><span id="userChipName">â€”</span><span class="role-badge" id="userChipRole">â€”</span></div>
    <select class="ctrl" id="buildingSelect" onchange="filterBuilding()"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option></select>
    <button class="btn" onclick="openAddModal()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙƒØ¨Ø©</button>
    <button class="btn logout" onclick="doLogout()">Ø®Ø±ÙˆØ¬ â†©</button>
  </div>
</header>

<div class="main">
  <aside>
    <div class="nav-label">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
    <div class="nav-item active" onclick="showPage('vehicles',this)"><span class="icon">ğŸš—</span> Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
    <div class="nav-item" onclick="showPage('reports',this)"><span class="icon">ğŸ“Š</span> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    <div class="nav-item admin-only" onclick="showPage('settings',this)"><span class="icon">âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    <div class="sidebar-divider"></div>
    <div id="buildingBadge" style="display:none" class="building-badge"></div>
    <div class="nav-label">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
    <div class="sidebar-stat"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</span><span class="val" id="sb-total" style="color:var(--accent)">0</span></div>
    <div id="sb-status-list"></div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-stat"><span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥ØµÙ„Ø§Ø­</span><span class="val" id="sb-avg" style="color:var(--accent)">â€”</span></div>
  </aside>

  <div class="content">

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª -->
    <div class="page active" id="page-vehicles">
      <div class="page-title">Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
      <div class="page-subtitle" id="vehicles-subtitle">// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©</div>
      <div class="filter-bar">
        <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£Ùˆ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³..." id="searchInput" oninput="renderVehicles()" style="min-width:210px;">
        <div class="tag-row" id="statusFilterTags"></div>
      </div>
      <div class="vehicles-grid" id="vehiclesGrid"></div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div class="page" id="page-reports">
      <div class="page-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
      <div class="page-subtitle">// Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</div>
      <div class="reports-grid" id="reportsGrid"></div>
      <div class="status-breakdown" id="statusBreakdown"></div>
      <div class="chart-section" id="bldChartSection">
        <div class="chart-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ù„ÙƒÙ„ Ù…Ø¨Ù†Ù‰</div>
        <div class="bar-chart" id="buildingChart"></div>
      </div>
      <div class="chart-section">
        <div class="chart-title">Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© â€” Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</div>
        <div class="bar-chart" id="dailyChart"></div>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) -->
    <div class="page" id="page-settings">
      <div class="page-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      <div class="page-subtitle">// Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØªÙØ­ÙØ¸ ÙˆØªÙØ²Ø§Ù…Ù† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙˆØ±Ø§Ù‹</div>
      <div class="settings-grid">
        <div class="settings-card">
          <div class="settings-card-title">ğŸ¢ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</div>
          <div class="settings-card-sub">// Ø§Ø¶ØºØ· ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©</div>
          <ul class="item-list" id="buildings-list"></ul>
          <div class="add-item-row">
            <input type="text" id="new-building" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰..." onkeydown="if(event.key==='Enter')addBuilding()"/>
            <button class="btn sm" onclick="addBuilding()">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
        <div class="settings-card">
          <div class="settings-card-title">ğŸš— Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</div>
          <div class="settings-card-sub">// Ø§Ø¶ØºØ· ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©</div>
          <ul class="item-list" id="types-list"></ul>
          <div class="add-item-row">
            <input type="text" id="new-type" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©..." onkeydown="if(event.key==='Enter')addType()"/>
            <button class="btn sm" onclick="addType()">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
        <div class="settings-card">
          <div class="settings-card-title">ğŸ“‹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div>
          <div class="settings-card-sub">// Ø§Ø¶ØºØ· ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©</div>
          <ul class="item-list" id="statuses-list"></ul>
          <div class="add-item-row">
            <input type="text" id="new-status" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø©..." onkeydown="if(event.key==='Enter')addStatus()"/>
            <button class="btn sm" onclick="addStatus()">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
          <div style="margin-top:12px;font-size:10px;color:var(--text-dim);margin-bottom:5px;font-weight:700;">Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
          <div class="color-swatches" id="colorSwatches"></div>
        </div>
        <div class="settings-card">
          <div class="settings-card-title">ğŸ’¾ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          <div class="settings-card-sub">// Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØªØµØ¯ÙŠØ±</div>
          <div class="data-info" id="dataInfo">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
          <div class="data-actions">
            <button class="btn sm" onclick="forceSave()">â˜ Ø­ÙØ¸ ÙˆØªØ²Ø§Ù…Ù†</button>
            <button class="btn sm secondary" onclick="exportData()">â¬‡ ØªØµØ¯ÙŠØ± JSON</button>
            <label class="btn sm secondary" style="cursor:pointer">â¬† Ø§Ø³ØªÙŠØ±Ø§Ø¯<input type="file" accept=".json" onchange="importData(event)" style="display:none"></label>
          </div>
          <div class="danger-zone">
            <div class="danger-zone-label">// Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</div>
            <button class="btn sm danger" onclick="resetToDefaults()">â†º Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±ÙƒØ¨Ø© -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOuter(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙƒØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="f-id"/>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙƒØ¨Ø© *</label><input class="form-input" id="f-num" placeholder="Ù…Ø«Ø§Ù„: VH-0042"/></div>
        <div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© *</label><select class="form-select" id="f-type"></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„ *</label><input class="form-input" id="f-date" type="date"/></div>
        <div class="form-group" id="modal-building-group"><label class="form-label">Ø§Ù„Ù…Ø¨Ù†Ù‰</label><select class="form-select" id="f-building"></select></div>
      </div>
      <div class="form-group"><label class="form-label">Ø§Ù„Ø¶Ø§Ø¨Ø· / Ø¶Ø§Ø¨Ø· Ø§Ù„ØµÙ</label><input class="form-input" id="f-eng" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¶Ø§Ø¨Ø· Ø£Ùˆ Ø¶Ø§Ø¨Ø· Ø§Ù„ØµÙ"/></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Ø±Ù‚Ù… ØªØµØ¯ÙŠÙ‚</label><input class="form-input" id="f-tasdiq" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØµØ¯ÙŠÙ‚..."/></div>
        <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø¥Ø°Ù† Ø§Ù„Ø´ØºÙ„</label><input class="form-input" id="f-izn" placeholder="Ø±Ù‚Ù… Ø¥Ø°Ù† Ø§Ù„Ø´ØºÙ„..."/></div>
      </div>
      <div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„ *</label><input class="form-input" id="f-fault" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„..."/></div>
      <div class="form-group"><label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ *</label><select class="form-select" id="f-status"></select></div>
      <div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-textarea" id="f-notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn" onclick="saveVehicle()">Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† â€” Ù…Ø­ÙÙˆØ¸ÙˆÙ† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø«Ø§Ø¨ØªÙˆÙ† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const USERS = [
  { username:'admin',   password:'admin2024', role:'admin', building:null, display:'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…'    },
  { username:'Ù…Ø¨Ù†Ù‰1',  password:'b1pass',    role:'user',  building:'B1', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 1'  },
  { username:'Ù…Ø¨Ù†Ù‰2',  password:'b2pass',    role:'user',  building:'B2', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 2'  },
  { username:'Ù…Ø¨Ù†Ù‰3',  password:'b3pass',    role:'user',  building:'B3', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 3'  },
  { username:'Ù…Ø¨Ù†Ù‰4',  password:'b4pass',    role:'user',  building:'B4', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 4'  },
  { username:'Ù…Ø¨Ù†Ù‰5',  password:'b5pass',    role:'user',  building:'B5', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 5'  },
  { username:'Ù…Ø¨Ù†Ù‰6',  password:'b6pass',    role:'user',  building:'B6', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 6'  },
  { username:'Ù…Ø¨Ù†Ù‰7',  password:'b7pass',    role:'user',  building:'B7', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 7'  },
  { username:'Ù…Ø¨Ù†Ù‰8',  password:'b8pass',    role:'user',  building:'B8', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 8'  },
  { username:'Ù…Ø¨Ù†Ù‰9',  password:'b9pass',    role:'user',  building:'B9', display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 9'  },
  { username:'Ù…Ø¨Ù†Ù‰10', password:'b10pass',   role:'user',  building:'B10',display:'Ù‚Ø§Ø¦Ø¯ Ù…Ø¨Ù†Ù‰ 10' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_DATA = {
  buildings:[
    {id:'B1',name:'Ù…Ø¨Ù†Ù‰ 1'},{id:'B2',name:'Ù…Ø¨Ù†Ù‰ 2'},{id:'B3',name:'Ù…Ø¨Ù†Ù‰ 3'},
    {id:'B4',name:'Ù…Ø¨Ù†Ù‰ 4'},{id:'B5',name:'Ù…Ø¨Ù†Ù‰ 5'},{id:'B6',name:'Ù…Ø¨Ù†Ù‰ 6'},
    {id:'B7',name:'Ù…Ø¨Ù†Ù‰ 7'},{id:'B8',name:'Ù…Ø¨Ù†Ù‰ 8'},{id:'B9',name:'Ù…Ø¨Ù†Ù‰ 9'},
    {id:'B10',name:'Ù…Ø¨Ù†Ù‰ 10'},
  ],
  vehicleTypes:['Ø³ÙŠØ§Ø±Ø©','Ù…Ø±Ø§Ø¨','Ù…Ø¯Ø±Ø¹Ø©','Ø´Ø§Ø­Ù†Ø©','Ù†Ø§Ù‚Ù„Ø© Ø¬Ù†Ø¯ Ù…Ø¯Ø±Ø¹Ø©','Ù‡Ø§Ù…ÙÙŠ','Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©'],
  statuses:[
    {id:'repair',name:'ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­',color:'#e8743a'},
    {id:'awaiting',name:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±',color:'#3ab8e8'},
    {id:'repaired',name:'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­',color:'#3ae89a'},
    {id:'delivered',name:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',color:'#5a6478'},
  ],
  vehicles:[
    {id:1,num:'VH-0017',type:'Ù…Ø±Ø§Ø¨',           date:'2026-02-10',building:'B1', engineer:'Ù†Ù‚ÙŠØ¨ Ø­Ø³Ù†',   fault:'Ø¹Ø·Ù„ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ùƒ',          status:'repair',   notes:''},
    {id:2,num:'VH-0033',type:'Ù…Ø¯Ø±Ø¹Ø©',          date:'2026-02-12',building:'B3', engineer:'Ø±Ù‚ÙŠØ¨ Ø®Ø§Ù„Ø¯', fault:'ØªÙ„Ù ÙÙŠ Ù†Ø§Ù‚Ù„ Ø§Ù„Ø­Ø±ÙƒØ©',     status:'awaiting', notes:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±'},
    {id:3,num:'VH-0005',type:'Ø³ÙŠØ§Ø±Ø©',          date:'2026-02-05',building:'B2', engineer:'Ù…Ù„Ø§Ø²Ù… Ø¹Ù…Ø±',  fault:'Ø¹Ø·Ù„ ÙÙŠ Ø§Ù„ÙØ±Ø§Ù…Ù„',         status:'repaired', notes:'Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ÙØ­Øµ'},
    {id:4,num:'VH-0041',type:'Ø´Ø§Ø­Ù†Ø©',          date:'2026-02-08',building:'B5', engineer:'Ù†Ù‚ÙŠØ¨ ÙŠÙˆØ³Ù', fault:'ØªÙ„Ù ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚',         status:'delivered',notes:''},
    {id:5,num:'VH-0022',type:'Ù‡Ø§Ù…ÙÙŠ',          date:'2026-02-14',building:'B4', engineer:'Ø±Ù‚ÙŠØ¨ Ø­Ø³Ù†',  fault:'Ù‚ØµØ± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ',            status:'repair',   notes:''},
    {id:6,num:'VH-0009',type:'Ù†Ø§Ù‚Ù„Ø© Ø¬Ù†Ø¯ Ù…Ø¯Ø±Ø¹Ø©',date:'2026-02-13',building:'B7', engineer:'Ø±Ø§Ø¦Ø¯ ÙØ±ÙŠØ¯', fault:'ØªÙ„Ù ÙÙŠ Ø§Ù„Ø¬Ù†Ø§Ø²ÙŠØ±',        status:'awaiting', notes:'Ø·Ù„Ø¨ Ø¹Ø§Ø¬Ù„'},
    {id:7,num:'VH-0055',type:'Ù…Ø±Ø§Ø¨',           date:'2026-02-15',building:'B1', engineer:'Ù†Ù‚ÙŠØ¨ Ø­Ø³Ù†',  fault:'Ø¹Ø·Ù„ ÙÙŠ Ø¢Ù„ÙŠØ© Ø§Ù„Ø¨Ø±Ø¬',      status:'repair',   notes:''},
    {id:8,num:'VH-0018',type:'Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©',   date:'2026-01-28',building:'B9', engineer:'Ø¬Ù†Ø¯ÙŠ Ø£Ø­Ù…Ø¯', fault:'ØªØ¢ÙƒÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø©',           status:'delivered',notes:''},
  ],
  nextId:9, nextBId:11, nextSId:5,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let buildings=[], vehicleTypes=[], statuses=[], vehicles=[];
let nextId=9, nextBId=11, nextSId=5;
const PALETTE=['#e8743a','#3ab8e8','#3ae89a','#e84a3a','#e8b13a','#a64de8','#e84a8c','#4de8c2','#e8d83a','#8ce83a'];
let selectedColor=PALETTE[0];
let filterSt='', filterBld='';
let currentUser=null;
let isSaving=false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ø¨Ø± window.storage (Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHARED_KEY='fleet_shared_data';

async function saveShared(){
  if(isSaving) return;
  isSaving=true;
  setSyncBadge('saving');
  const state={buildings,vehicleTypes,statuses,vehicles,nextId,nextBId,nextSId,savedAt:Date.now()};
  try{
    await window.storage.set(SHARED_KEY,JSON.stringify(state),true);
    setSyncBadge('synced');
  }catch(e){
    // fallback to localStorage if storage API unavailable
    try{localStorage.setItem('fleet_local',JSON.stringify(state));}catch(e2){}
    setSyncBadge('error','Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·');
  }
  isSaving=false;
}

async function loadShared(){
  showLoading(true);
  try{
    const res=await window.storage.get(SHARED_KEY,true);
    if(res && res.value){
      const state=JSON.parse(res.value);
      applyState(state);
      setSyncBadge('synced');
      showLoading(false);
      return true;
    }
  }catch(e){}
  // fallback: try localStorage
  try{
    const raw=localStorage.getItem('fleet_local');
    if(raw){const state=JSON.parse(raw);applyState(state);setSyncBadge('error','Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·');showLoading(false);return true;}
  }catch(e){}
  // use defaults
  applyState(DEFAULT_DATA);
  setSyncBadge('error','Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
  showLoading(false);
  return false;
}

function applyState(state){
  buildings    = state.buildings    || JSON.parse(JSON.stringify(DEFAULT_DATA.buildings));
  vehicleTypes = state.vehicleTypes || [...DEFAULT_DATA.vehicleTypes];
  statuses     = state.statuses     || JSON.parse(JSON.stringify(DEFAULT_DATA.statuses));
  vehicles     = state.vehicles     || JSON.parse(JSON.stringify(DEFAULT_DATA.vehicles));
  nextId       = state.nextId       || DEFAULT_DATA.nextId;
  nextBId      = state.nextBId      || DEFAULT_DATA.nextBId;
  nextSId      = state.nextSId      || DEFAULT_DATA.nextSId;
}

function setSyncBadge(type,customText){
  const el=document.getElementById('syncBadge');
  if(!el)return;
  el.className='sync-badge '+type;
  if(type==='synced') el.textContent='âœ“ Ù…ÙØ²Ø§Ù…Ù†';
  else if(type==='saving') el.textContent='âŸ³ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
  else el.textContent='âš  '+(customText||'Ø®Ø·Ø£');
}

function showLoading(show){
  document.getElementById('loadingOverlay').classList.toggle('show',show);
}

// auto-reload shared data every 30 seconds while logged in
setInterval(()=>{
  if(currentUser){
    loadShared().then(()=>{if(currentUser)renderAll();});
  }
},30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const getBld  = id => buildings.find(x=>x.id===id);
const getSt   = id => statuses.find(x=>x.id===id);
const bldName = id => { const b=getBld(id); return b?b.name:id; };
const stName  = id => { const s=getSt(id);  return s?s.name:id; };
const stColor = id => { const s=getSt(id);  return s?s.color:'#5a6478'; };
const fmtDate = d  => d?new Date(d).toLocaleDateString('ar-EG',{day:'2-digit',month:'short',year:'numeric'}):'â€”';
const isAdmin = ()  => currentUser && currentUser.role==='admin';
const userBld = ()  => currentUser ? currentUser.building : null;

function toast(msg,err=false){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.borderColor=err?'var(--red)':'var(--green)';t.style.color=err?'var(--red)':'var(--green)';
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„Ø®Ø±ÙˆØ¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  const found=USERS.find(x=>x.username===u&&x.password===p);
  if(!found){
    const err=document.getElementById('loginError');
    err.classList.add('show');setTimeout(()=>err.classList.remove('show'),3000);
    return;
  }
  currentUser=found;
  document.getElementById('loginScreen').style.display='none';
  applyUserContext();
  loadShared().then(()=>{renderAll();toast('Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ '+currentUser.display+'!');});
}

function doLogout(){
  currentUser=null;filterSt='';filterBld='';
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
  document.getElementById('loginScreen').style.display='flex';
}

function applyUserContext(){
  document.getElementById('userChipName').textContent=currentUser.display;
  const rb=document.getElementById('userChipRole');
  rb.textContent=isAdmin()?'Ø£Ø¯Ù…Ù†':'Ù…Ø³ØªØ®Ø¯Ù…';
  rb.className='role-badge '+(isAdmin()?'admin':'user');
  document.querySelectorAll('.admin-only').forEach(el=>el.style.display=isAdmin()?'':'none');
  const badge=document.getElementById('buildingBadge');
  if(!isAdmin()&&userBld()){
    badge.style.display='block';
    badge.textContent='ğŸ¢ '+bldName(userBld());
    filterBld=userBld();
    document.getElementById('buildingSelect').style.display='none';
  }else{
    badge.style.display='none';
    document.getElementById('buildingSelect').style.display='';
  }
  document.getElementById('vehicles-subtitle').textContent=
    isAdmin()?'// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª':'// Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© â€” '+bldName(userBld());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªÙ†Ù‚Ù„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name,el){
  if(name==='settings'&&!isAdmin()){toast('ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø·Ù„ÙˆØ¨Ø©.',true);return;}
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  el.classList.add('active');
  renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ÙÙ„Ø§ØªØ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFilterTags(){
  document.getElementById('statusFilterTags').innerHTML=
    `<button class="tag ${filterSt===''?'active':''}" onclick="setStatusFilter('')">Ø§Ù„ÙƒÙ„</button>`+
    statuses.map(s=>`<button class="tag ${filterSt===s.id?'active':''}" onclick="setStatusFilter('${s.id}')">${s.name}</button>`).join('');
}
function setStatusFilter(st){filterSt=st;renderFilterTags();renderVehicles();}
function filterBuilding(){filterBld=document.getElementById('buildingSelect').value;renderVehicles();}

function populateHeaderSelects(){
  const bs=document.getElementById('buildingSelect');
  const saved=bs.value;
  bs.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>'+buildings.map(b=>`<option value="${b.id}" ${saved===b.id?'selected':''}>${b.name}</option>`).join('');
}

function populateFormSelects(v=null){
  document.getElementById('f-type').innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>'+vehicleTypes.map(t=>`<option ${v&&v.type===t?'selected':''}>${t}</option>`).join('');
  const mg=document.getElementById('modal-building-group');
  if(!isAdmin()){mg.style.display='none';}
  else{mg.style.display='';document.getElementById('f-building').innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰</option>'+buildings.map(b=>`<option value="${b.id}" ${v&&v.building===b.id?'selected':''}>${b.name}</option>`).join('');}
  document.getElementById('f-status').innerHTML=statuses.map(s=>`<option value="${s.id}" ${v&&v.status===s.id?'selected':''}>${s.name}</option>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFiltered(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  const bf=isAdmin()?filterBld:userBld();
  return vehicles.filter(v=>
    (!filterSt||v.status===filterSt)&&(!bf||v.building===bf)&&
    (!q||v.num.toLowerCase().includes(q)||(v.engineer||'').toLowerCase().includes(q)));
}

function renderVehicles(){
  renderFilterTags();
  const grid=document.getElementById('vehiclesGrid');
  const list=getFiltered();
  if(!list.length){grid.innerHTML='<div class="empty"><div class="empty-icon">ğŸš§</div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ±</div>';return;}
  grid.innerHTML=list.map(v=>{
    const c=stColor(v.status);
    const opts=statuses.map(s=>`<option value="${s.id}" ${v.status===s.id?'selected':''}>${s.name}</option>`).join('');
    return`<div class="vehicle-card">
      <div class="vc-stripe" style="background:${c}"></div>
      <div class="vc-num">${v.num}</div>
      <div class="vc-type">${v.type}${v.building?' â€” '+bldName(v.building):''}</div>
      <div class="vc-row">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„ <span>${fmtDate(v.date)}</span></div>
      <div class="vc-row">Ø§Ù„Ø¶Ø§Ø¨Ø· / Ø¶Ø§Ø¨Ø· Ø§Ù„ØµÙ <span>${v.engineer||'â€”'}</span></div>
      ${v.tasdiq?`<div class="vc-row">Ø±Ù‚Ù… ØªØµØ¯ÙŠÙ‚ <span>${v.tasdiq}</span></div>`:''}
      ${v.izn?`<div class="vc-row">Ø±Ù‚Ù… Ø¥Ø°Ù† Ø§Ù„Ø´ØºÙ„ <span>${v.izn}</span></div>`:''}
      <div class="vc-row">Ø§Ù„Ù…Ø¨Ù†Ù‰ <span>${v.building?bldName(v.building):'â€”'}</span></div>
      <div class="vc-row">Ø§Ù„Ø¹Ø·Ù„ <span>${v.fault}</span></div>
      <div class="status-badge" style="color:${c};background:${c}18;border-color:${c}44">${stName(v.status)}</div>
      <div class="vc-actions">
        <select class="form-select" style="flex:1;font-size:12px;padding:5px 8px" onchange="changeStatus(${v.id},this.value)">${opts}</select>
        <button class="btn sm ghost" onclick="openEditModal(${v.id})">ØªØ¹Ø¯ÙŠÙ„</button>
        ${isAdmin()?`<button class="btn sm danger" onclick="deleteVehicle(${v.id})">Ø­Ø°Ù</button>`:''}
      </div>
    </div>`;
  }).join('');
}

function changeStatus(id,st){
  const v=vehicles.find(x=>x.id===id);
  if(v){v.status=st;renderAll();saveShared().then(()=>{});toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: '+stName(st));}
}
function deleteVehicle(id){
  if(!isAdmin()){toast('ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø·Ù„ÙˆØ¨Ø©.',true);return;}
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©ØŸ'))return;
  vehicles=vehicles.filter(v=>v.id!==id);renderAll();saveShared().then(()=>{});toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙƒØ¨Ø©.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddModal(){
  populateFormSelects();
  document.getElementById('modal-title').textContent='ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙƒØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©';
  document.getElementById('f-id').value='';
  ['f-num','f-fault','f-eng','f-notes','f-tasdiq','f-izn'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('modalOverlay').classList.add('open');
}
function openEditModal(id){
  const v=vehicles.find(x=>x.id===id);if(!v)return;
  populateFormSelects(v);
  document.getElementById('modal-title').textContent='ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© â€” '+v.num;
  document.getElementById('f-id').value=v.id;
  document.getElementById('f-num').value=v.num;
  document.getElementById('f-date').value=v.date;
  document.getElementById('f-eng').value=v.engineer||'';
  document.getElementById('f-tasdiq').value=v.tasdiq||'';
  document.getElementById('f-izn').value=v.izn||'';
  document.getElementById('f-fault').value=v.fault;
  document.getElementById('f-notes').value=v.notes||'';
  if(isAdmin())document.getElementById('f-building').value=v.building||'';
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open');}
function closeModalOuter(e){if(e.target===document.getElementById('modalOverlay'))closeModal();}

function saveVehicle(){
  const num=document.getElementById('f-num').value.trim();
  const type=document.getElementById('f-type').value;
  const date=document.getElementById('f-date').value;
  const fault=document.getElementById('f-fault').value.trim();
  const st=document.getElementById('f-status').value;
  if(!num||!type||!date||!fault||!st){toast('âš  ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©.',true);return;}
  const bld=isAdmin()?document.getElementById('f-building').value:userBld();
  const data={num,type,date,fault,status:st,building:bld,
    engineer:document.getElementById('f-eng').value,
    tasdiq:document.getElementById('f-tasdiq').value.trim(),
    izn:document.getElementById('f-izn').value.trim(),
    notes:document.getElementById('f-notes').value};
  const eid=document.getElementById('f-id').value;
  if(eid){const i=vehicles.findIndex(v=>v.id==eid);if(i!==-1)vehicles[i]={...vehicles[i],...data};toast('âœ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±ÙƒØ¨Ø©.');}
  else{vehicles.push({id:nextId++,...data});toast('âœ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© '+num+'.');}
  closeModal();renderAll();saveShared().then(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcAvgTime(){
  const scope=isAdmin()?vehicles:vehicles.filter(v=>v.building===userBld());
  const done=scope.filter(v=>['repaired','delivered'].includes(v.status));
  if(!done.length)return null;
  return Math.round(done.reduce((a,v)=>a+Math.round((Date.now()-new Date(v.date))/86400000),0)/done.length);
}
function renderReports(){
  const scope=isAdmin()?vehicles:vehicles.filter(v=>v.building===userBld());
  const bySt=id=>scope.filter(v=>v.status===id).length;
  const completed=statuses.filter(s=>['repaired','delivered'].includes(s.id)).reduce((a,s)=>a+bySt(s.id),0);
  const avg=calcAvgTime();
  const bldCounts=buildings.map(b=>({name:b.name,cnt:scope.filter(v=>v.building===b.id).length}));
  const maxBld=bldCounts.reduce((a,b)=>b.cnt>a.cnt?b:a,{cnt:0,name:'â€”'});
  document.getElementById('reportsGrid').innerHTML=`
    <div class="report-card"><div class="report-icon">ğŸš—</div><div class="report-value">${scope.length}</div><div class="report-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª</div></div>
    <div class="report-card"><div class="report-icon">âœ…</div><div class="report-value" style="color:var(--green)">${completed}</div><div class="report-label">Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div></div>
    <div class="report-card"><div class="report-icon">â±ï¸</div><div class="report-value" style="color:var(--accent2);font-size:30px">${avg?avg+' ÙŠÙˆÙ…':'â€”'}</div><div class="report-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div></div>
    ${isAdmin()?`<div class="report-card"><div class="report-icon">ğŸ¢</div><div class="report-value" style="color:var(--red);font-size:24px;line-height:1.2">${maxBld.cnt?maxBld.name:'â€”'}</div><div class="report-label">Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹</div></div>`:''}`;
  document.getElementById('statusBreakdown').innerHTML=
    statuses.map(s=>`<div class="sb-card"><div class="sb-val" style="color:${s.color}">${bySt(s.id)}</div><div class="sb-lab">${s.name}</div></div>`).join('');
  const bcs=document.getElementById('bldChartSection');
  bcs.style.display=isAdmin()?'':'none';
  if(isAdmin()){
    const counts=buildings.map(b=>vehicles.filter(v=>v.building===b.id).length);
    const bMax=Math.max(...counts,1);
    document.getElementById('buildingChart').innerHTML=
      buildings.map((b,i)=>`<div class="bar-group"><div class="bar-val">${counts[i]}</div><div class="bar" style="height:${Math.round((counts[i]/bMax)*110)+4}px"></div><div class="bar-label">${b.name.replace('Ù…Ø¨Ù†Ù‰ ','#')}</div></div>`).join('');
  }
  const days=[];
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const str=d.toISOString().split('T')[0];
    days.push({lbl:d.toLocaleDateString('ar-EG',{weekday:'short'}),cnt:scope.filter(v=>v.date===str).length});
  }
  const dMax=Math.max(...days.map(d=>d.cnt),1);
  document.getElementById('dailyChart').innerHTML=
    days.map(d=>`<div class="bar-group"><div class="bar-val">${d.cnt}</div><div class="bar" style="height:${Math.round((d.cnt/dMax)*110)+4}px"></div><div class="bar-label">${d.lbl}</div></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSidebar(){
  const scope=isAdmin()?vehicles:vehicles.filter(v=>v.building===userBld());
  document.getElementById('sb-total').textContent=scope.length;
  document.getElementById('sb-status-list').innerHTML=
    statuses.map(s=>`<div class="sidebar-stat"><span>${s.name}</span><span class="val" style="color:${s.color}">${scope.filter(v=>v.status===s.id).length}</span></div>`).join('');
  const avg=calcAvgTime();
  document.getElementById('sb-avg').textContent=avg?avg+' ÙŠÙˆÙ…':'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeListItem(label,colorDot,onEdit,onDelete){
  const li=document.createElement('li');
  const row=document.createElement('div');row.className='item-row';
  if(colorDot){const dot=document.createElement('div');dot.className='item-color-dot';dot.style.background=colorDot;row.appendChild(dot);}
  const ns=document.createElement('div');ns.className='item-name';ns.textContent=label;row.appendChild(ns);
  const eb=document.createElement('button');eb.className='btn sm ghost';eb.textContent='ØªØ¹Ø¯ÙŠÙ„';row.appendChild(eb);
  const db=document.createElement('button');db.className='btn sm danger';db.textContent='âœ•';row.appendChild(db);
  const er=document.createElement('div');er.className='item-edit-row';
  const inp=document.createElement('input');inp.type='text';inp.value=label;
  const sb=document.createElement('button');sb.className='btn sm';sb.textContent='Ø­ÙØ¸';
  er.appendChild(inp);er.appendChild(sb);li.appendChild(row);li.appendChild(er);
  eb.onclick=()=>{const open=er.classList.contains('active');ns.style.display=open?'':'none';er.classList.toggle('active',!open);if(!open)inp.focus();};
  sb.onclick=()=>{const v=inp.value.trim();if(!v)return;ns.textContent=v;ns.style.display='';er.classList.remove('active');onEdit(v);};
  inp.onkeydown=e=>{if(e.key==='Enter')sb.click();};
  db.onclick=onDelete;
  return li;
}
function renderSettingsBuildings(){
  const ul=document.getElementById('buildings-list');if(!ul)return;ul.innerHTML='';
  buildings.forEach(b=>ul.appendChild(makeListItem(b.name,null,
    v=>{b.name=v;renderAll();saveShared().then(()=>{});toast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰.');},
    ()=>deleteBuilding(b.id))));
}
function addBuilding(){
  const v=document.getElementById('new-building').value.trim();
  if(!v){toast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰.',true);return;}
  buildings.push({id:'B'+(nextBId++),name:v});
  document.getElementById('new-building').value='';renderAll();saveShared().then(()=>{});toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù†Ù‰: '+v);
}
function deleteBuilding(id){
  if(vehicles.some(v=>v.building===id)&&!confirm('ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù†Ù‰. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ'))return;
  buildings=buildings.filter(b=>b.id!==id);vehicles.forEach(v=>{if(v.building===id)v.building='';});
  renderAll();saveShared().then(()=>{});toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù†Ù‰.');
}
function renderSettingsTypes(){
  const ul=document.getElementById('types-list');if(!ul)return;ul.innerHTML='';
  vehicleTypes.forEach((t,i)=>ul.appendChild(makeListItem(t,null,
    v=>{vehicleTypes[i]=v;renderAll();saveShared().then(()=>{});toast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù†ÙˆØ¹.');},
    ()=>{if(!confirm('Ø­Ø°Ù Ø§Ù„Ù†ÙˆØ¹ "'+vehicleTypes[i]+'"ØŸ'))return;vehicleTypes.splice(i,1);renderAll();saveShared().then(()=>{});toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†ÙˆØ¹.');})));
}
function addType(){
  const v=document.getElementById('new-type').value.trim();
  if(!v){toast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù†ÙˆØ¹.',true);return;}
  vehicleTypes.push(v);document.getElementById('new-type').value='';renderAll();saveShared().then(()=>{});toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ÙˆØ¹: '+v);
}
function renderSettingsStatuses(){
  const ul=document.getElementById('statuses-list');if(!ul)return;ul.innerHTML='';
  statuses.forEach(s=>ul.appendChild(makeListItem(s.name,s.color,
    v=>{s.name=v;renderAll();saveShared().then(()=>{});toast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø©.');},
    ()=>deleteStatus(s.id))));
  document.getElementById('colorSwatches').innerHTML=PALETTE.map(c=>
    `<div class="swatch ${selectedColor===c?'selected':''}" style="background:${c}" onclick="selectColor('${c}')"></div>`).join('');
}
function selectColor(c){selectedColor=c;renderSettingsStatuses();}
function addStatus(){
  const v=document.getElementById('new-status').value.trim();
  if(!v){toast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø©.',true);return;}
  statuses.push({id:'st'+(nextSId++),name:v,color:selectedColor});
  document.getElementById('new-status').value='';renderAll();saveShared().then(()=>{});toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø©: '+v);
}
function deleteStatus(id){
  if(statuses.length<=1){toast('ÙŠØ¬Ø¨ Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø©.',true);return;}
  if(vehicles.some(v=>v.status===id)&&!confirm('ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø§Øª Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ'))return;
  statuses=statuses.filter(s=>s.id!==id);vehicles.forEach(v=>{if(v.status===id)v.status=statuses[0].id;});
  renderAll();saveShared().then(()=>{});toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø§Ù„Ø©.');
}
function renderSettings(){
  if(!isAdmin())return;
  renderSettingsBuildings();renderSettingsTypes();renderSettingsStatuses();renderDataInfo();
}
function renderDataInfo(){
  const el=document.getElementById('dataInfo');if(!el)return;
  el.innerHTML=`Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª: <span>${vehicles.length}</span> | Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ: <span>${buildings.length}</span> | Ø§Ù„Ø­Ø§Ù„Ø§Øª: <span>${statuses.length}</span><br>ÙˆØ¶Ø¹ Ø§Ù„Ø­ÙØ¸: <span>Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªØµØ¯ÙŠØ± / Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ / Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function forceSave(){saveShared().then(()=>{toast('âœ“ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.');});}
function exportData(){
  const state={buildings,vehicleTypes,statuses,vehicles,nextId,nextBId,nextSId,exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='Ù…ØªØ§Ø¨Ø¹Ø©-Ø§Ù„Ø§Ù†ØªØ§Ø¬-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();URL.revokeObjectURL(url);toast('âœ“ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
}
function importData(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const state=JSON.parse(e.target.result);
      if(!state.vehicles||!state.buildings)throw new Error();
      if(!confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'))return;
      applyState(state);renderAll();saveShared().then(()=>{});toast('âœ“ ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
    }catch{toast('âš  Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.',true);}
    event.target.value='';
  };reader.readAsText(file);
}
function resetToDefaults(){
  if(!confirm('Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.'))return;
  applyState(JSON.parse(JSON.stringify(DEFAULT_DATA)));
  renderAll();saveShared().then(()=>{});toast('â†º ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªØµÙŠÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  if(!currentUser)return;
  populateHeaderSelects();renderFilterTags();renderVehicles();updateSidebar();renderReports();renderSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('loginUser').focus();
</script>
</body>
</html>